<!DOCTYPE html>
<html lang="mk">
<head>
  <meta charset="UTF-8" />
  <title>Tile AR – Auto Floor/Wall (Поправена вертикална логика)</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    body {
      text-align: center;
      font-family: sans-serif;
      margin-top: 50px;
    }

    /* Главниот model-viewer за AR */
    #viewer {
      width: 100%;
      max-width: 800px;
      height: 600px;
      border: 1px solid #ccc;
      margin-bottom: 40px;
    }

    /* Копче за View in AR */
    #ar-button {
      padding: 12px 24px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      background-color: #333;
      color: white;
      cursor: pointer;
    }
    #ar-button:hover {
      background-color: #555;
    }
  </style>
</head>
<body>

<h1>Tiles for walls and floors</h1>

<!-- 1. Главниот model-viewer, кој ја отвора AR-сесијата -->
<model-viewer
        id="viewer"
        src="models/tile_floor.glb"
        ios-src="models/tile_floor.usdz"
        alt="Tiles for walls and floors"
        camera-controls
        auto-rotate
        auto-rotate-delay="1s"
        camera-orbit="45deg 75deg 2.5m"
        camera-target="0m 0m 0m"
        field-of-view="50deg"
        environment-image="neutral"
        ar
        ar-modes="scene-viewer quick-look webxr"
        ar-scale="auto"
        style="width: 100%; height: 600px;"
></model-viewer>

<!-- 2. Копче за стартување на AR-сесијата -->
<button id="ar-button">📱 View in AR</button>

<script>
  const viewer = document.getElementById('viewer');
  const btnAR = document.getElementById('ar-button');

  let fallbackTimer = null;
  let triedFloor = false;

  btnAR.addEventListener('click', () => {
    // Кога кликнеме, прво поставуваме хоризонтален модел и стартуваме AR-сесија
    setToFloor();
    activateARSession();

    // Сетиме тајмер од 3 секунди за обид со vertical доколку floor не се пронајде
    clearTimeout(fallbackTimer);
    fallbackTimer = setTimeout(() => {
      // Ако AR сѐ уште е активна (floor не е залепена) 
      // прво ја затвораме (exitAR), па после кратко време ја рестартираме со wall
      viewer.exitAR().finally(() => {
        setToWall();
        // мало одложување за да се осигура дека AR сесијата е вистински затворена
        setTimeout(() => {
          activateARSession();
        }, 100);
      });
    }, 3000);
  });

  function setToFloor() {
    triedFloor = true;
    // Менуваме 3D-фајловите за под/horizontal
    viewer.setAttribute('src', 'models/tile_floor.glb');
    viewer.setAttribute('ios-src', 'models/tile_floor.usdz');
    // Поставуваме anchoring на хоризонтална рамнина
    viewer.setAttribute('ar-placement', 'floor');
  }

  function setToWall() {
    // Менуваме 3D-фајловите за ѕид/vertical
    viewer.setAttribute('src', 'models/tile_wall.glb');
    viewer.setAttribute('ios-src', 'models/tile_wall.usdz');
    // Поставуваме anchoring на вертикална рамнина
    viewer.setAttribute('ar-placement', 'wall');
  }

  function activateARSession() {
    if (viewer && typeof viewer.activateAR === 'function') {
      viewer.activateAR();
    } else {
      alert("AR не е поддржано или моделот не е вчтен.");
    }
  }

  // Ако корисникот ја напушти AR-сесијата порано (на пример, кога најде floor),
  // го бришеме тајмерот за vertical fallback
  viewer.addEventListener('ar-status', (event) => {
    if (event.detail.status === 'disabled') {
      clearTimeout(fallbackTimer);
    }
  });
</script>

</body>
</html>
